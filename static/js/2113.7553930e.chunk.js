"use strict";(globalThis.webpackChunkimaps_app=globalThis.webpackChunkimaps_app||[]).push([[2113],{66038:(e,t,i)=>{i.d(t,{w:()=>M});var n=i(27366),s=i(91505),r=i(41691),o=i(84652),a=i(92026),p=i(66978),l=i(94172),c=i(17842),h=i(49861),d=(i(25243),i(69912)),u=i(70178),g=i(74509),m=i(50951),v=i(78005);class _{constructor(e){let{grabbableForEvent:t}=e;this.events=new s.Z,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.grabbableForEvent=t}intersectionDistance(e,t){return 0}attach(){}detach(){}}var y=i(14813),f=i(74229),x=i(84954),C=i(87268),w=i(52349),S=i(77560),b=i(34019),T=i(80151),P=i(71040);let M=class extends(s.Z.EventedMixin(r.r)){constructor(e){super(e),this._createOperationCompleted=!1,this._pointerDownStates=new Set,this._snappingPipeline=new T.n,this.isDraped=!0,this.labelOptions=new w.Z,this.tooltipOptions=new S.Z,this.snapToSceneEnabled=null,this.lastVertex=null,(0,a.Wi)(e.elevationInfo)&&(this.elevationInfo=(0,g.mF)(e.hasZ))}initialize(){const{geometryType:e,view:t}=this,{spatialReference:i}=t,n="viewingMode"in t.state?t.state.viewingMode:m.JY.Local,s="segment"===e||"multipoint"===e?"polyline":e;this.coordinateHelper=(0,y.Y6)(this.hasZ,this.hasM,i),this._editGeometryOperations=new C.c(new x.XE(s,this.coordinateHelper)),this._snappingOperation=new P.y({view:t,constrainResult:e=>(0,a.Wi)(e)?e:this._getEffectiveDrawSurface().constrainZ(e)}),this.handles.add((0,l.YP)((()=>this.stagedVertex),(e=>{(0,a.Wi)(e)||this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(e)}],operation:"apply",type:"vertex-update"})}),{sync:!0,equals:(e,t)=>(0,a._W)(e,t,u.k)})),this._activeComponent=new x.wA(i,n),this._editGeometryOperations.data.components.push(this._activeComponent);const r=this.segmentLabels;(0,a.pC)(r)&&(r.context={view:t,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions},this.handles.add([(0,l.YP)((()=>this.labelOptions.enabled),(e=>{r.visible=e}),l.tX),this.on("cursor-update",(()=>{const e=this.stagedVertex;r.stagedVertex=(0,a.pC)(e)?this.coordinateHelper.pointToVector(e):null}))])),this.handles.add(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],(e=>{const t=e.vertices.map((e=>({componentIndex:0,vertexIndex:e.index,coordinates:this.coordinateHelper.vectorToArray(e.pos)}))),i=t.map((e=>e.coordinates));switch(e.type){case"vertex-add":this.emit(e.type,{...e,added:i,vertices:t});break;case"vertex-update":this.emit(e.type,{...e,updated:i,vertices:t});break;case"vertex-remove":this.emit(e.type,{...e,removed:i,vertices:t})}const n=this._activeComponent.getLastVertex(),s=(0,a.pC)(n)?this.coordinateHelper.vectorToDehydratedPoint(n.pos):null;((0,a.Wi)(s)||(0,a.Wi)(this.lastVertex)||!(0,u.k)(this.lastVertex,s))&&(this.lastVertex=s)}))),this._manipulator=new _({grabbableForEvent:e=>"click"!==this.drawingMode||"touch"===e.pointerType&&this._snappingEnabled&&1===this._pointerDownStates.size}),this.manipulators.add(this._manipulator),this._manipulator.grabbable="point"!==e,this.handles.add([this._createManipulatorDragPipeline(this._manipulator),this._manipulator.events.on("immediate-click",(e=>this._onImmediateClick(e))),this._manipulator.events.on("immediate-double-click",(e=>this._onImmediateDoubleClick(e)))])}destroy(){(0,a.SC)(this.segmentLabels),(0,a.SC)(this._snappingOperation),this._editGeometryOperations=(0,a.SC)(this._editGeometryOperations)}get _snappingEnabled(){return(0,a.pC)(this.snappingManager)&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const e=this._getEffectiveDrawSurface();return"3d"===this.view.type&&this.drawSurface!==e}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activeComponent.vertices.map((e=>this.coordinateHelper.vectorToArray(e.pos)))}set drawingMode(e){this._set("drawingMode",e??v.n)}get interactive(){return this._manipulator.interactive}set interactive(e){this._manipulator.interactive=e}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activeComponent.vertices.length}get numVertices(){return(0,a.pC)(this.stagedVertex)?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length}get stagedVertex(){return this._snappingOperation.stagedPoint}set stagedVertex(e){this._snappingOperation.stagedPoint=(0,o.d9)(e)}get updating(){return this.updatingHandles.updating}get vertices(){const e=this.committedVertices;return(0,a.pC)(this.stagedVertex)&&e.push(this.coordinateHelper.pointToArray(this.stagedVertex)),e}cancel(){this.complete({aborted:!0})}commitStagedVertex(){if(this._snappingOperation.abort(),(0,a.pC)(this.stagedVertex)){const{stagedVertex:e}=this;this.stagedVertex=null,this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(e))}}complete(e){const t=e&&e.aborted||!1;this._snappingOperation.abort(),(0,a.pC)(this.snappingManager)&&this.snappingManager.doneSnapping(),"segment"===this.geometryType||"point"===this.geometryType?this.commitStagedVertex():this.stagedVertex=null;const i="multipoint"===this.geometryType&&0===this.numVertices||"polyline"===this.geometryType&&this.numVertices<2||"polygon"===this.geometryType&&this.numVertices<3;this._createOperationCompleted=!i,(this.isCompleted||t)&&this.emit("complete",{vertices:this.vertices.map(((e,t)=>({componentIndex:0,vertexIndex:t,coordinates:e}))),aborted:t,type:"complete"})}onInputEvent(e){switch(e.type){case"pointer-down":this._pointerDownStates.add(e.pointerId);break;case"pointer-up":this._pointerDownStates.delete(e.pointerId)}switch(e.type){case"pointer-move":return this._onPointerMove(e);case"hold":return this._onHold(e)}}redo(){this._editGeometryOperations.redo()}undo(){(0,a.pC)(this.snappingManager)&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_closeOnClickVertexIndex(e){const t=this._activeComponent;if("polygon"===this.geometryType&&t.vertices.length>2){if(this._vertexWithinPointerDistance(t.vertices[0].pos,e))return 0;if(this._vertexWithinPointerDistance(t.vertices[t.vertices.length-1].pos,e))return t.vertices.length-1}return null}_createManipulatorDragPipeline(e){switch((0,a.Wg)(this.drawingMode)){case"click":return this._createManipulatorDragPipelineClick(e);case"freehand":return this._createManipulatorDragPipelineFreehand(e);case"hybrid":return this._createManipulatorDragPipelineHybrid(e)}}_createManipulatorDragPipelineClick(e){return(0,f.Xd)(e,((e,t,i,n)=>{const s="touch"===n&&this._snappingEnabled;!this.isCompleted&&s&&(i=i.next((e=>(s&&(0,a.pC)(this.snappingManager)&&this.snappingManager.doneSnapping(),e))),t.next(this._screenToMapDragEventStep()).next((e=>("start"===e.action&&(this.stagedVertex=e.mapStart,("segment"===this.geometryType||s&&0===this.numVertices)&&this.commitStagedVertex()),e))).next((0,f.BS)(this.view,this.elevationInfo)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>s,cancel:i,snappingManager:this.snappingManager,snappingContext:new b.N({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:n,visualizer:this.snappingVisualizer}),updatingHandles:this.updatingHandles,useZ:!this._requiresScenePoint}),this._snappingPipeline.next).next((e=>(s&&(this.stagedVertex=e.mapEnd,"end"===e.action&&this.commitStagedVertex()),e))).next((e=>("end"===e.action&&("segment"!==this.geometryType&&"point"!==this.geometryType||this.complete()),e))))}))}_createManipulatorDragPipelineFreehand(e){return(0,f.Xd)(e,((e,t)=>{this.isCompleted||t.next(this._screenToMapDragEventStep()).next((e=>("start"===e.action&&((0,a.Wi)(this.stagedVertex)&&(this.stagedVertex=e.mapStart),"segment"===this.geometryType&&this.commitStagedVertex()),e))).next((e=>{switch(e.action){case"start":case"update":this.stagedVertex=e.mapEnd,"polygon"!==this.geometryType&&"polyline"!==this.geometryType||this.commitStagedVertex();break;case"end":this.complete()}return e}))}))}_createManipulatorDragPipelineHybrid(e){return(0,f.Xd)(e,((e,t)=>{this.isCompleted||t.next(this._screenToMapDragEventStep()).next((e=>("start"===e.action&&((0,a.Wi)(this.stagedVertex)&&(this.stagedVertex=e.mapStart),this.commitStagedVertex()),e))).next((e=>{switch(e.action){case"start":case"update":this.stagedVertex=e.mapEnd,"polygon"!==this.geometryType&&"polyline"!==this.geometryType||this.commitStagedVertex();break;case"end":"segment"!==this.geometryType&&"point"!==this.geometryType||this.complete()}return e}))}))}get _drawAtFixedElevation(){return("segment"===this.geometryType||"polygon"===this.geometryType)&&this.numCommittedVertices>0}_getEffectiveDrawSurface(){if((0,a.Wi)(this.elevationDrawSurface))return this.drawSurface;if(!this.coordinateHelper.hasZ())return this.elevationDrawSurface.defaultZ=null,this.elevationDrawSurface;let e=this.defaultZ,t=!1;return(0,a.pC)(this.elevationInfo)&&"absolute-height"===this.elevationInfo.mode&&(t=!0),(0,a.pC)(this.snapToSceneEnabled)&&(t=this.snapToSceneEnabled),(0,a.pC)(this.elevationInfo)&&"on-the-ground"===this.elevationInfo.mode&&(t=!1),this._drawAtFixedElevation&&(e=this.coordinateHelper.getZ(this._activeComponent.vertices[0].pos),t=!1),t?this.drawSurface:(this.elevationDrawSurface.defaultZ=e,this.elevationDrawSurface)}_mapToScreen(e){return this._getEffectiveDrawSurface().mapToScreen(e)}_onHold(e){this._snappingOperation.abort(),"click"===this.drawingMode&&"touch"===e.pointerType&&this._snappingEnabled&&(this.stagedVertex=e.mapPoint),e.stopPropagation()}_onImmediateClick(e){if("mouse"===e.pointerType&&2===e.button||this._manipulator.dragging)return;const t=this._activeComponent,i=this._closeOnClickVertexIndex(e.screenPoint);if((0,a.pC)(i))return e.stopPropagation(),void this.complete();const n=this._screenToMap(e.screenPoint);if((0,a.pC)(n))switch(this.drawingMode){case"freehand":"point"===this.geometryType&&((0,a.pC)(this.stagedVertex)?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),this.complete());break;case"click":case"hybrid":this._snappingOperation.abort(),(0,a.pC)(this.stagedVertex)?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),("point"===this.geometryType||"segment"===this.geometryType&&2===t.vertices.length||"segment"===this.geometryType&&"hybrid"===this.drawingMode&&1===t.vertices.length)&&this.complete()}e.stopPropagation()}_onImmediateDoubleClick(e){this._manipulator.dragging||"point"===this.geometryType||(this.complete(),e.stopPropagation())}_onPointerMove(e){const t=(0,c.vW)(e.x,e.y),i=this._snappingOperation;if(this._manipulator.dragging||this._pointerDownStates.has(e.pointerId)||this._manipulator.grabbing||!this._manipulator.interactive)return void i.abort();e.stopPropagation();const n=this._closeOnClickVertexIndex(t);if((0,a.pC)(n))return this._closeOnVertex(n),void i.abort();const s=this._screenToMap(t),r=this._requiresScenePoint?this.drawSurface.screenToMap(t):null;if(this._manipulator.cursor=(0,a.pC)(s)?"crosshair":null,(0,a.Wi)(s))return void i.abort();const o=this.snappingManager;if((0,a.Wi)(o))return this.stagedVertex=s,void i.abort();const l=this._drawAtFixedElevation?(0,a.yw)(this.elevationDrawSurface,(e=>{let{defaultZ:t}=e;return t})):null,h=new b.N({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:e.pointerType,visualizer:this.snappingVisualizer,selfSnappingZ:(0,a.pC)(l)?{value:l,elevationInfo:this.elevationInfo}:null});this.updatingHandles.addPromise((0,p.R8)(i.snap({point:s,scenePoint:r},o,h)))}_closeOnVertex(e){this.stagedVertex=null;const t={componentIndex:0,vertexIndex:e,coordinates:this.coordinateHelper.vectorToArray(this._activeComponent.vertices[e].pos)};this.emit("cursor-update",{updated:null,vertices:[t],operation:"apply",type:"vertex-update"})}_screenToMap(e){return this._getEffectiveDrawSurface().screenToMap(e)}_screenToMapDragEventStep(){let e=null;return t=>{if("start"===t.action&&(e=this._screenToMap(t.screenStart)),(0,a.Wi)(e))return null;const i=this._screenToMap(t.screenEnd);return(0,a.pC)(i)?{...t,mapStart:e,mapEnd:i}:null}}_vertexWithinPointerDistance(e,t){const i=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(e));return!!(0,a.pC)(i)&&function(e,t,i){const n=e.x-t.x,s=e.y-t.y;return n*n+s*s<=i}(i,t,25)}};(0,n._)([(0,h.Cb)()],M.prototype,"_snappingEnabled",null),(0,n._)([(0,h.Cb)()],M.prototype,"defaultZ",void 0),(0,n._)([(0,h.Cb)()],M.prototype,"isDraped",void 0),(0,n._)([(0,h.Cb)({value:v.n})],M.prototype,"drawingMode",null),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"elevationDrawSurface",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"elevationInfo",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0,type:w.Z})],M.prototype,"labelOptions",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0,type:S.Z})],M.prototype,"tooltipOptions",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"geometryType",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"hasM",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"hasZ",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"manipulators",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"drawSurface",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"segmentLabels",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"snappingManager",void 0),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"snappingVisualizer",void 0),(0,n._)([(0,h.Cb)()],M.prototype,"snapToSceneEnabled",void 0),(0,n._)([(0,h.Cb)()],M.prototype,"_snappingOperation",void 0),(0,n._)([(0,h.Cb)()],M.prototype,"stagedVertex",null),(0,n._)([(0,h.Cb)()],M.prototype,"lastVertex",void 0),(0,n._)([(0,h.Cb)()],M.prototype,"updating",null),(0,n._)([(0,h.Cb)({constructOnly:!0})],M.prototype,"view",void 0),M=(0,n._)([(0,d.j)("esri.views.draw.DrawOperation")],M)},78005:(e,t,i)=>{i.d(t,{A:()=>n,n:()=>s});const n=["freehand","hybrid","click"],s="click"},54016:(e,t,i)=>{i.d(t,{aL:()=>p,hP:()=>c,iW:()=>l});var n=i(92026),s=i(17842),r=i(65618),o=i(37818),a=i(74509);class p{constructor(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._elevationInfo=e,this.defaultZ=t,this._view=i,this._excludeGraphics=n}screenToMap(e){if((0,n.pC)(this.defaultZ))return this._view.sceneIntersectionHelper.intersectElevationFromScreen((0,s.s1)(e.x,e.y),this._elevationInfo,this.defaultZ,this._excludeGraphics);const t=this._view.sceneIntersectionHelper.intersectElevationFromScreen((0,s.s1)(e.x,e.y),this._elevationInfo,0,this._excludeGraphics);return(0,n.pC)(t)&&(t.z=void 0),t}mapToScreen(e){const t=(0,r.Tx)(e.x,e.y,(0,a.vQ)(this._view,e,this._elevationInfo),e.spatialReference);return this._view.toScreen(t)}constrainZ(e){const{defaultZ:t}=this;return(0,n.pC)(t)&&e.z!==t&&((e=(0,o.WG)(e)).z=t),e}}class l{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];this.view=e,this.elevationInfo=t,this.exclude=i}screenToMap(e){const t=this.view.toMap(e,{exclude:this.exclude});return(0,n.pC)(t)&&(t.z=(0,a.Ou)(t,this.view,this.elevationInfo)),t}mapToScreen(e){let t=e;return(0,n.pC)(this.elevationInfo)&&(t=(0,r.Tx)(e.x,e.y,(0,a.vQ)(this.view,e,this.elevationInfo),e.spatialReference)),this.view.toScreen(t)}constrainZ(e){return e}}class c{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.view=e,this.hasZ=t,this.defaultZ=i,this.mapToScreen=t=>e.toScreen(t),this.screenToMap=t?t=>{const n=e.toMap(t);return n.z=i,n}:t=>e.toMap(t)}constrainZ(e){const{defaultZ:t}=this;return this.hasZ&&e.z!==t&&((e=(0,o.WG)(e)).z=t),e}}},3826:(e,t,i)=>{i.d(t,{Gn:()=>_,Q8:()=>u});i(59486);var n=i(92026),s=i(22018),r=i(89494),o=i(48976),a=i(98131),p=i(11186),l=i(71353),c=i(14320),h=i(585);function d(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,n.pC)(i)?[e,t,i]:[e,t]}function u(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,n.pC)(i)?{x:e,y:t,z:i}:{x:e,y:t}}class g{constructor(e){this.spatialReference=e}mapToLocalMultiple(e){return(0,n.lV)(e.map((e=>this.mapToLocal(e))))}get doUnnormalization(){return!1}}class m extends g{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;super(t),this._defaultZ=i,this.transform=(0,r.c)(),this.transformInv=(0,r.c)(),this.transform=(0,r.a)(e),(0,s.c)(this.transformInv,this.transform)}makeMapPoint(e,t){return d(e,t,this._defaultZ)}mapToLocal(e){return u(this.transform[0]*e[0]+this.transform[2]*e[1]+this.transform[4],this.transform[1]*e[0]+this.transform[3]*e[1]+this.transform[5])}localToMap(e){return d(this.transformInv[0]*e.x+this.transformInv[2]*e.y+this.transformInv[4],this.transformInv[1]*e.x+this.transformInv[3]*e.y+this.transformInv[5],this._defaultZ)}}class v extends g{constructor(e,t){super(e.spatialReference),this.view=e,this.defaultZ=null,this.pWS=(0,l.c)(),this.tangentFrameUpWS=(0,l.c)(),this.tangentFrameRightWS=(0,l.c)(),this.tangentFrameForwardWS=(0,l.c)(),this.localFrameRightWS=(0,l.c)(),this.localFrameUpWS=(0,l.c)(),this.worldToLocalTransform=(0,a.a)(),this.localToWorldTransform=(0,a.a)(),this.scale=1,this.scale=e.resolution,this.referenceMapPoint=t,this.defaultZ=t.hasZ?t.z:null;const i=e.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,c.R.X,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,c.R.Y,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,c.R.Z,this.tangentFrameForwardWS);const n=(0,l.c)();(0,p.g)(n,this.tangentFrameForwardWS,(0,p.e)(i,this.tangentFrameForwardWS)),(0,p.b)(this.localFrameRightWS,i,n),(0,p.n)(this.localFrameRightWS,this.localFrameRightWS),(0,p.f)(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),(0,o.r)(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),(0,o.i)(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return"global"===this.view.viewingMode}makeMapPoint(e,t){return d(e,t,this.defaultZ)}mapToLocal(e){const t=(0,l.c)();this.view.renderCoordsHelper.toRenderCoords(new h.Z({x:e[0],y:e[1],spatialReference:this.spatialReference}),t),(0,p.q)(t,t,this.worldToLocalTransform);const i=this.view.renderCoordsHelper.fromRenderCoords(t,this.view.spatialReference);return(0,n.pC)(i)?u(i.x/this.scale,i.y/this.scale):null}localToMap(e){const t=(0,l.c)();this.view.renderCoordsHelper.toRenderCoords(new h.Z({x:e.x*this.scale,y:e.y*this.scale,spatialReference:this.spatialReference}),t),(0,p.q)(t,t,this.localToWorldTransform);const i=this.view.renderCoordsHelper.fromRenderCoords(t,this.view.spatialReference);return(0,n.pC)(i)?d(i.x,i.y,this.defaultZ):null}}function _(e,t){if("2d"===e.type)return new m(e.state.transform,e.spatialReference,t.length>2?t[2]:null);if("3d"===e.type){const i=t.length>2?new h.Z({x:t[0],y:t[1],z:t[2],spatialReference:e.spatialReference}):new h.Z({x:t[0],y:t[1],spatialReference:e.spatialReference});return new v(e,i)}return null}},80151:(e,t,i)=>{i.d(t,{n:()=>c});var n=i(92026),s=i(66978),r=i(70178),o=i(37818),a=i(74229),p=i(34019),l=i(78307);class c{constructor(){this.next=new a.hM}createSnapDragEventPipelineStep(e){let{predicate:t=(()=>!0),cancel:i,snappingManager:r,snappingContext:o,updatingHandles:p,useZ:l=!0}=e;if((0,n.Wi)(r))return e=>e;let c=null,h=null;const d=()=>{c=(0,n.IM)(c),r.doneSnapping(),(0,n.pC)(h)&&h.frameTask.remove(),h=null};i.next((e=>(d(),e))),this.next=new a.hM;const u=this._createSnapFunction(r,l);let g=null,m=null,v=null;return e=>{if(!t(e))return e;if("start"===e.action){const t=this._createFrameTask(r.view);if(h=this._createSnappingInfo(o,e,t),h.context.selfSnappingZ=null,!l&&(0,n.pC)(e.info)){const t=this._extractSelfSnappingZ(o.coordinateHelper,e.info.handle.component);(0,n.pC)(t)&&(h.context.selfSnappingZ={value:t,elevationInfo:o.elevationInfo})}}if((0,n.pC)(h)){const{context:t,originalScenePos:i,originalPos:o}=h,{mapEnd:a,mapStart:d,action:_,scenePoints:y}=e,f=this._updatePosition(o,this._computeMapDelta(a,d)),x=this._computeMapDelta(d,o),C={...e,action:"update"},w=h.context,S=this._updateScenePosition(i,y),b=r.update({point:f,scenePoint:S,context:t});if(v=b,this._applySnappedUpdate(a,b,x,l),g=f,m=S,"end"!==_){const{frameTask:e}=h;(0,n.Wi)(c)&&(c=new AbortController),p.addPromise((0,s.R8)(u({frameTask:e,event:C,context:w,point:f,scenePoint:S,delta:x,lastPos:g,lastScenePos:m,lastUpdate:v},c.signal)))}}return"end"===e.action&&d(),e}}_createSnapFunction(e,t){return(0,s.Ds)((async(i,s)=>{let{frameTask:o,point:a,scenePoint:p,context:l,event:c,delta:h,lastPos:d,lastScenePos:u,lastUpdate:g}=i;const m=await o.schedule((()=>e.snap({point:a,scenePoint:p,context:l,signal:s})),s);if(m.valid){let i=await o.schedule((()=>m.apply()),s);a!==d&&(0,n.pC)(d)&&(i=e.update({point:d,scenePoint:u,context:l})),(0,r.k)(i,g)||(this._applySnappedUpdate(c.mapEnd,i,h,t),this.next.execute(c))}}))}_createFrameTask(e){return"3d"===e.type?e.resourceController.scheduler.registerTask(l.T8.SNAPPING):l.sq}_createSnappingInfo(e,t,i){return{context:new p.N({editGeometryOperations:e.editGeometryOperations,elevationInfo:e.elevationInfo,pointer:e.pointer,vertexHandle:(0,n.pC)(t.info)?t.info.handle:null,excludeFeature:e.excludeFeature,visualizer:e.visualizer}),originalPos:(0,n.pC)(t.snapOrigin)?e.coordinateHelper.vectorToDehydratedPoint(t.snapOrigin):t.mapStart,originalScenePos:(0,n.pC)(t.scenePoints)?t.scenePoints.sceneStart:null,frameTask:i}}_updatePosition(e,t){let[i,n,s]=t;const r=(0,o.WG)(e);return r.x+=i,r.y+=n,r.hasZ&&(r.z+=s),r}_updateScenePosition(e,t){return(0,n.Wi)(e)||(0,n.Wi)(t)?null:this._updatePosition(e,this._computeMapDelta(t.sceneEnd,t.sceneStart))}_computeMapDelta(e,t){const i=e.hasZ&&t.hasZ?e.z-t.z:0;return[e.x-t.x,e.y-t.y,i]}_applySnappedUpdate(e,t,i,n){let[s,r,o]=i;e.x=t.x+s,e.y=t.y+r,n&&e.hasZ&&t.hasZ&&(e.z=t.z+o)}_extractSelfSnappingZ(e,t){if(!e.hasZ())return null;const i=t.vertices;let s=null;for(const r of i){const t=e.getZ(r.pos);if((0,n.pC)(s)&&Math.abs(t-s)>1e-6)return null;(0,n.Wi)(s)&&(s=t)}return s}}},71040:(e,t,i)=>{i.d(t,{y:()=>c});var n=i(27366),s=i(85015),r=i(92026),o=i(66978),a=i(49861),p=(i(63780),i(25243),i(69912)),l=i(78307);let c=class extends s.Z{constructor(e){super(e),this.constrainResult=e=>e,this._snapPoints=null,this._abortController=null,this._stagedPoint=null,this._snap=(0,o.Ds)((async(e,t,i,n)=>{const s=await this._frameTask.schedule((()=>t.snap({...e,context:i,signal:n})),n);s.valid&&await this._frameTask.schedule((()=>{this.stagedPoint=s.apply(),e!==this._snapPoints&&(0,r.pC)(this._snapPoints)&&(this.stagedPoint=t.update({...this._snapPoints,context:i}))}),n)}))}get stagedPoint(){return this._stagedPoint}set stagedPoint(e){this._stagedPoint=this.constrainResult(e)}initialize(){const e="3d"===this.view.type?this.view?.resourceController?.scheduler:null;this._frameTask=(0,r.pC)(e)?e.registerTask(l.T8.SNAPPING):l.sq}destroy(){this._abortController=(0,r.IM)(this._abortController),this._frameTask=(0,r.hw)(this._frameTask)}async snap(e,t,i){const{point:n,scenePoint:s}=e;return this.stagedPoint=t.update({point:n,scenePoint:s,context:i}),this._snapPoints=e,(0,r.Wi)(this._abortController)&&(this._abortController=new AbortController),this._snap(e,t,i,this._abortController.signal)}abort(){this._abortController=(0,r.IM)(this._abortController)}};(0,n._)([(0,a.Cb)({constructOnly:!0})],c.prototype,"view",void 0),(0,n._)([(0,a.Cb)()],c.prototype,"stagedPoint",null),(0,n._)([(0,a.Cb)()],c.prototype,"constrainResult",void 0),(0,n._)([(0,a.Cb)()],c.prototype,"_stagedPoint",void 0),c=(0,n._)([(0,p.j)("esri.views.interactive.snapping.SnappingOperation")],c)}}]);
//# sourceMappingURL=2113.7553930e.chunk.js.map